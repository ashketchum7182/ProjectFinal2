<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Swap Portal</title>
<style>
  body {
    background-color: #0d1117;
    color: #c9d1d9;
    font-family: 'Poppins', sans-serif;
    text-align: center;
    padding: 20px;
  }
  h1 { color: #58a6ff; }
  form {
    background-color: #161b22;
    padding: 25px;
    border-radius: 15px;
    display: inline-block;
    box-shadow: 0 0 10px #30363d;
  }
  label { display: block; margin: 10px 0 5px; }
  input, select {
    padding: 8px;
    width: 220px;
    border-radius: 6px;
    border: none;
    margin-bottom: 10px;
    background-color: #0d1117;
    color: white;
    border: 1px solid #30363d;
  }
  button {
    background-color: #238636;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover { background-color: #2ea043; }
  .match {
    background-color: #161b22;
    border: 2px solid #30363d;
    border-radius: 12px;
    padding: 15px;
    margin-top: 20px;
    text-align: left;
  }
</style>
</head>
<body>

<h1>ðŸ‘• Uniform Swap Portal</h1>
<p>Enter your details below to find matching swaps!</p>

<form id="swapForm">
  <label>Name:</label>
  <input type="text" id="name" required>

  <label>PRN (11 digits):</label>
  <input type="text" id="prn" pattern="\d{11}" maxlength="11" required title="Enter 11 digit PRN">

  <label>Email:</label>
  <input type="email" id="email" required>

  <label>Phone (WhatsApp):</label>
  <input type="tel" id="contact" required>

  <label>Branch:</label>
  <select id="branch" required>
    <option value="AIML">AIML</option>
    <option value="ENTC">ENTC</option>
    <option value="RA">RA</option>
    <option value="CIVIL">CIVIL</option>
    <option value="MECHANICAL">MECHANICAL</option>
    <option value="CSE">CSE ðŸ¤®</option>
  </select>

  <label>Year:</label>
  <select id="year" required>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
  </select>

  <label>Gender:</label>
  <select id="gender" required>
    <option value="Male">Male</option>
    <option value="Female">Female</option>
  </select>

  <label>Item Type:</label>
  <select id="item" required>
    <option value="Shirt">Shirt</option>
    <option value="Pant">Pant</option>
    <option value="Blazer">Blazer</option>
  </select>

  <label>Your Current Size:</label>
  <select id="size" required>
    <script>
      for(let i=28;i<=46;i+=2){
        document.write(`<option value="${i}">${i}</option>`);
      }
    </script>
  </select>

  <label>Size You Want:</label>
  <select id="wants" required>
    <script>
      for(let i=28;i<=46;i+=2){
        document.write(`<option value="${i}">${i}</option>`);
      }
    </script>
  </select>

  <button type="submit">Submit</button>
</form>

<h2>ðŸ”„ Swap Matches</h2>
<div id="matches"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
  // âœ… Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD6_SdYU3LlhAry4718CdlUk84ORF0c4j4",
    authDomain: "project1-32227.firebaseapp.com",
    databaseURL: "https://project1-32227-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "project1-32227",
    storageBucket: "project1-32227.firebasestorage.app",
    messagingSenderId: "995436990407",
    appId: "1:995436990407:web:44714a76b7fdc9ecfcd3e2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // âœ… Initialize EmailJS
  emailjs.init("ncvQolKw6IrCUfnEw");

  const form = document.getElementById("swapForm");
  const matchesDiv = document.getElementById("matches");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const entry = {
      name: form.name.value,
      prn: form.prn.value,
      email: form.email.value,
      contact: form.contact.value,
      branch: form.branch.value,
      year: form.year.value,
      gender: form.gender.value,
      item: form.item.value,
      size: form.size.value,
      wants: form.wants.value,
      action: "Swap"
    };

    db.ref("entries").push(entry);
    alert("âœ… Entry submitted successfully!");
    form.reset();
  });

  db.ref("entries").on("value", (snapshot) => {
    const entries = [];
    snapshot.forEach(child => entries.push(child.val()));
    matchesDiv.innerHTML = "";
    findMultiSwaps(entries);
  });

  function sendEmail(user) {
    emailjs.send("service_6v2o2yi", "template_tsm7cwa", {
      to_name: user.name,
      to_email: user.email,
      message: `Hi ${user.name}, a uniform swap match has been found! Check the portal or contact others via WhatsApp.`
    });
  }

  function findMultiSwaps(entries) {
    const swaps = entries.filter(e => e.action === "Swap");
    const visited = new Set();

    function dfs(path, start) {
      const last = path[path.length - 1];
      for (const next of swaps) {
        if (next.gender !== start.gender || next.item !== start.item) continue;
        if (last.wants == next.size) {
          if (next.prn === start.prn && path.length >= 2) {
            const cycle = [...path];
            const key = cycle.map(x => x.prn).join("-");
            if (!visited.has(key)) {
              visited.add(key);
              const match = document.createElement("div");
              match.className = "match";
              match.innerHTML = `<h3 style="color:#ffcc00;">${path.length}-Way Swap Found!</h3>`;
              cycle.forEach(u => {
                match.innerHTML += `
                  <p><b>${u.name}</b> (PRN: ${u.prn}, ${u.branch}, Year ${u.year}, ${u.gender})<br>
                  Item: ${u.item}, Size: ${u.size} â†’ Wants: ${u.wants}<br>
                  ðŸ“§ <a href="mailto:${u.email}" style="color:#58a6ff;">${u.email}</a><br>
                  ðŸ“± <a href="https://wa.me/${u.contact}" target="_blank" style="color:#58a6ff;">${u.contact}</a></p>
                  <hr style="border:1px solid #30363d;">`;
                sendEmail(u);
              });
              match.innerHTML += `<b>Cycle:</b> ${cycle.map(c => c.name).join(" â†’ ")} â†’ ${cycle[0].name}`;
              matchesDiv.appendChild(match);
            }
          } else if (!path.find(p => p.prn === next.prn)) {
            dfs([...path, next], start);
          }
        }
      }
    }

    for (const user of swaps) {
      dfs([user], user);
    }
  }
</script>
</body>
</html>
